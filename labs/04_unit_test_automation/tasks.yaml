apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: echo
spec:
  params:
    - name: message
      description: The message to echo
      type: string
  steps:
    - name: echo-message
      image: alpine:3
      command: [/bin/echo]
      args: ["$(params.message)"]
      #  OpenShift's Pod Security admission controller
      securityContext:
        runAsNonRoot: true
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cleanup
spec:
  description: This task will clean up a workspace by deleting all of the files.
  workspaces:
    - name: source
  steps:
    - name: remove
      image: alpine:3
      env:
        - name: WORKSPACE_SOURCE_PATH
          value: $(workspaces.source.path)
      workingDir: $(workspaces.source.path)
      #  OpenShift's Pod Security admission controller
      securityContext:
        runAsNonRoot: true
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
      script: |
        #!/usr/bin/env sh
        set -eu
        echo "Removing all files from ${WORKSPACE_SOURCE_PATH} ..."
        # Delete any existing contents of the directory if it exists.
        #
        # We don't just "rm -rf ${WORKSPACE_SOURCE_PATH}" because ${WORKSPACE_SOURCE_PATH} might be "/"
        # or the root of a mounted volume.
        if [ -d "${WORKSPACE_SOURCE_PATH}" ] ; then
          # Delete non-hidden files and directories
          rm -rf "${WORKSPACE_SOURCE_PATH:?}"/*
          # Delete files and directories starting with . but excluding ..
          rm -rf "${WORKSPACE_SOURCE_PATH}"/.[!.]*
          # Delete files and directories starting with .. plus any other character
          rm -rf "${WORKSPACE_SOURCE_PATH}"/..?*
        fi

---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: nose
spec:
  params:
    - name: args
      description: Arguments to pass to nose
      type: string
      default: "-v"
  workspaces:
    - name: source
  steps:
    - name: nosetests
      image: python:3.9-slim
      workingDir: $(workspaces.source.path)
      #  OpenShift's
      env:
      - name: HOME
        value: /tekton/home
      script: |
        #!/bin/bash
        set -e

        echo "***** Environment *****"
        python --version
        pwd

        echo "***** Installing dependencies *****"
        # 1. Ensure pip is updated and necessary tools are installed
        python -m pip install --upgrade pip wheel
        
        # 2. Install dependencies, including nose, from requirements.txt
        #    Use the --user flag to install packages into a non-root-owned directory
        #    which is common/necessary in secure container environments like OpenShift.
        pip install --user -r requirements.txt
        
        # 3. Add the user's bin directory to PATH
        #    This is where --user installations place executables like 'nosetests'.
        export PATH="$PATH:$HOME/.local/bin"
        
        # 4. Verification (Optional but highly recommended)
        if command -v nosetests &> /dev/null; then
            echo "nosetests is found at: $(command -v nosetests)"
        else
            echo "ERROR: nosetests command not found after installation!"
            exit 1
        fi

        echo "***** Running nosetests with: $(params.args)"
        nosetests $(params.args)
      #  OpenShift's Pod Security admission controller
      securityContext:
        runAsNonRoot: true
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
